---
title: "functions backup"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# MethodHistory, ScanHistory and pos-columns

## create_MethodHistory_of_chipIDs

```{r}
create_MethodHistory_of_chipIDs <- function(chip_IDs){

  query_results <- query_UID_limslager(chip_IDs = chip_IDs)
  EDLs <- get_EDL_from_query_result(query_results)
  MethodHistory <- purrr::map(EDLs,~create_MethodHistory_from_EDL(.x))

  return(MethodHistory)
}
```

## create_pos_df_from_MethodHistory

```{r}
create_pos_df_from_MethodHistory <- function(MethodHistory){
  columns <- purrr::map(MethodHistory,
                        ~.x%>%get_pos_colnames_in_MethodHistory)
  df <- purrr::map2(MethodHistory,
                    columns,
                    ~.x[,.y])
  df <- purrr::map(df,
                   ~.x%>%
                     tidyr::gather("column",
                                   "value",
                                   -UID,
                                   -CycleUID,
                                   -Excluded,
                                   -PreparedForDataviz))
  df <- purrr::map(df,
                   ~if(dim(.x)[2] == 4){
                     .x$column <- rep(NA,times=dim(.x)[1])
                     .x$value <- rep(NA,times=dim(.x)[1])
                     return(.x)
                   }else{return(.x)})
  return(df)
}

```

## create_ScanHistory_of_chipIDs

```{r}
create_ScanHistory_of_chipIDs<-function(chip_IDs){

  Method_History <- create_MethodHistory_of_chipIDs(chip_IDs)

  ScanHistorys <- purrr::map(MethodHistory,
                             ~.x%>%
                               dplyr::rename("scan_ID" = "UID")%>%
                               dplyr::rename("cycle_ID" = "CycleUID")%>%
                               tidyr::fill(cycle_ID,  .direction = "up")%>%
                               dplyr::filter(Type == "Chipcytometry-Scan")%>%
                               dplyr::select(scan_ID,cycle_ID,Status,Tag,Excluded,PreparedForDataviz))
  return(ScanHistorys)
}
```

## create_ScanHistory_from_MethodHistory

```{r}
create_ScanHistory_from_MethodHistory<-function(MethodHistory){

  ScanHistorys <- purrr::map(MethodHistory,
                             ~.x%>%
                               dplyr::rename("scan_ID" = "UID")%>%
                               dplyr::rename("cycle_ID" = "CycleUID")%>%
                               tidyr::fill(cycle_ID,  .direction = "up")%>%
                               dplyr::filter(Type == "Chipcytometry-Scan")%>%
                               dplyr::select(scan_ID,cycle_ID,Status,Tag,Excluded,PreparedForDataviz))
  return(ScanHistorys)
}

```

## extract_cycle_sequence_from_MethodHistory

```{r}
extract_cycle_sequence_from_MethodHistory <- function(MethodHistory){

  cycle_sequence <- purrr::map(MethodHistory,
                               ~.x%>%
                                 dplyr::filter(Type == "Chipcytometry-Cycle")%>%
                                 dplyr::rename("cycle_ID" = "UID")%>%
                                 dplyr::mutate(cycle_pos = 1:dplyr::n())%>%
                                 dplyr::select(cycle_pos,cycle_ID,Status,PreparedForDataviz))
  return(cycle_sequence)
}
```

## extract_OK_pos_from_MethodHistory

```{r}
extract_OK_pos_from_MethodHistory <- function(MethodHistory){

  df <- create_pos_df_from_MethodHistory(MethodHistory)

  OK_col <- purrr::map(df,
                       ~which(stringr::str_detect(.x$column,"OK")==TRUE))

  OK_scan <- purrr::map2(df,
                         OK_col,
                         ~.x[.y,])

  pos_df_OK <- purrr::map(OK_scan,
                          ~.x%>%
                            dplyr::filter(value== "True")%>%
                            dplyr::mutate(pos = column)%>%
                            dplyr::mutate(pos = stringr::str_remove(pos,"pos"))%>%
                            dplyr::mutate(pos = stringr::str_remove(pos,"OK"))%>%
                            dplyr::group_by(UID)%>%
                            dplyr::summarize(pos_OK = paste0(pos,collapse=", ")))

  return(pos_df_OK)
}
```

## extract_Ref_pos_from_MethodHistory

```{r}
extract_Ref_pos_from_MethodHistory <- function(MethodHistory){

  result <- create_pos_df_from_MethodHistory(MethodHistory)

  Ref_col <- purrr::map(result,
                        ~which(stringr::str_detect(.x$column,"Ref")==TRUE))

  Ref_scan <- purrr::map2(result,
                          Ref_col,
                          ~.x[.y,])

  pos_df_Ref <- purrr::map(Ref_scan,
                           ~.x%>%
                             dplyr::filter(value== "True")%>%
                             dplyr::mutate(pos = column)%>%
                             dplyr::mutate(pos = stringr::str_remove(pos,"pos"))%>%
                             dplyr::mutate(pos = stringr::str_remove(pos,"Ref"))%>%
                             dplyr::group_by(UID)%>%
                             dplyr::summarize(pos_Ref = paste0(pos,collapse=", "))
  )

  return(pos_df_Ref)
}
```

## extract_XYvalues_pos_from_MethodHistory

```{r}
extract_XYvalues_pos_from_MethodHistory <- function(MethodHistory){

  df <- create_pos_df_from_MethodHistory(MethodHistory)

  X_col <- purrr::map(df,
                      ~which(stringr::str_detect(.x$column,"X")==TRUE))
  X_scan <- purrr::map2(df,
                        X_col,
                        ~.x[.y,])
  pos_df_X <- purrr::map(X_scan,
                         ~.x%>%
                           dplyr::filter(!is.na(value))%>%
                           dplyr::mutate(pos = column)%>%
                           dplyr::mutate(pos = stringr::str_remove(pos,"pos"))%>%
                           dplyr::mutate(pos = stringr::str_remove(pos,"X"))%>%
                           dplyr::group_by(UID)%>%
                           dplyr::summarize(pos = paste0(pos,collapse=", "),
                                            value_X = paste0(value,collapse=", ")))

  Y_col <- purrr::map(df,
                      ~which(stringr::str_detect(.x$column,"Y")==TRUE))
  Y_scan <- purrr::map2(df,
                        Y_col,
                        ~.x[.y,])
  pos_df_Y <- purrr::map(Y_scan,
                         ~.x%>%
                           dplyr::filter(!is.na(value))%>%
                           dplyr::mutate(pos = column)%>%
                           dplyr::mutate(pos = stringr::str_remove(pos,"pos"))%>%
                           dplyr::mutate(pos = stringr::str_remove(pos,"Y"))%>%
                           dplyr::group_by(UID)%>%
                           dplyr::summarize(pos = paste0(pos,collapse=", "),
                                            value_Y = paste0(value,collapse=", ")))

  pos_df_XY <- purrr::map2(pos_df_X,
                           pos_df_Y,
                           ~dplyr::full_join(
                             .x%>%
                               tidyr::separate_rows(pos,value_X,sep =", "),
                             .y%>%
                               tidyr::separate_rows(pos,value_Y,sep =", "),
                             by = c("UID", "pos")
                           ))

  return(pos_df_XY)


}

```

## get_pos_colnames_in_MethodHistory

```{r}
get_pos_colnames_in_MethodHistory <- function(MH){
  cols <- colnames(MH)
  col_pos <- which(stringr::str_detect(cols,"pos")==TRUE)
  col_scanID <- which(cols %in% c("UID","CycleUID","Taq","Excluded","PreparedForDataviz"))
  return(c(col_scanID,col_pos))
}
```

# find all image pos of a scan {.tabset .tabset-pills}

## create_Pos_image_filepath()

```{r}
create_Pos_image_filepath <- function(ScanBasePath,
                                      PositionFolder,
                                      Type){
  Type <- match.arg(Type,choices = c("posRef",
                                     "flimages",
                                     "deltaTL",
                                     "focus",
                                     "hdr"))
  image_filepath <- file.path(ScanBasePath,
                                 PositionFolder,
                                 Type) 
  return(image_filepath)
}
```

## list_BlobFileName_in_filepath()

```{r}
list_BlobFileName_in_filepath <- function(image_filepath){
  
  #filetype <- tools::file_ext(filename)
  #filetype <- stringr::str_remove(filename, 
  #                                 "[^.]+")
  #test <- "hahaha.blob32"
  #test2 <- stringr::str_extract(test,"[^.blob]+")

# get_BLOB_filetype()
stringr::str_remove(test,test2)
  Files<-list.files(image_filepath)
  BlobFiles<-Files[stringr::str_detect(Files,".blob32$")]
  BlobFileName<-BlobFiles%>%stringr::str_remove(".blob32$")
  

  if(length(BlobFileName)==0){
     BlobFiles<-Files[stringr::str_detect(Files,".blob$")]
     BlobFileName<-BlobFiles%>%stringr::str_remove(".blob$")
  }
  
  if(length(BlobFileName)==0){return(NA)
  }else{return(BlobFileName)}
}
```

## list_posFolders_in_ScanBasePath()

```{r}
list_posFolders_in_ScanBasePath <- function(ScanBasePath){
  positions<-list.files(path=ScanBasePath)
  positions=positions[stringr::str_detect(positions,"pos")]
  return(positions)
}
```

# find_scan_basepath() {.tabset .tabset-pills}

## query_UID_scans()

```{r}
# find basePath to the image folder
#scan_IDs <- IDs$scan_ID[1:50]

query_UID_scans<- function(scan_IDs){
  result <- query_mongoDB("scans",
                          "UID",
                          scan_IDs)
  
  return(result)
}

#query_result <- query_UID_scans(scan_IDs)
```

## get_df_from_query_result()

```{r}
get_df_from_query_result<- function(query_result){
  
  result <- purrr::map_df(query_result$result, ~.x)
  
  return(result)
  
}
#df <- get_df_from_query_result(query_result)

#df%>%head()
```

## find_scan_basepath()

```{r}
find_scan_basepath <- function(scan_IDs){
  query_result <- query_UID_scans(scan_IDs)
  df <- get_df_from_query_result(query_result)
  return(df$basePath)
  
}

#IDs <- IDs%>%
#  dplyr::mutate(ScanBasePath = find_scan_basepath(scan_ID))

```

# check scanIDs for missinng image data() 

## get_pos_colnames_in_MethodHistory()

```{r}
get_pos_colnames_in_MethodHistory <- function(MH){
  cols <- colnames(MH)
  col_pos <- which(stringr::str_detect(cols,"pos")==TRUE)
  col_scanID <- which(cols %in% c("UID","CycleUID","Taq","Excluded","PreparedForDataviz"))
  return(c(col_scanID,col_pos))
}
```

## create_pos_df_from_MethodHistory()

```{r}
create_pos_df_from_MethodHistory <- function(MethodHistory){
  columns <- purrr::map(MethodHistory,
                          ~.x%>%get_pos_colnames_in_MethodHistory)
  df <- purrr::map2(MethodHistory,
                    columns,
                    ~.x[,.y])
  df <- purrr::map(df,
                   ~.x%>%
                     tidyr::gather("column",
                                   "value",
                                   -UID,
                                   -CycleUID,
                                   -Excluded,
                                   -PreparedForDataviz))
  df <- purrr::map(df,
                   ~if(dim(.x)[2] == 4){
                     .x$column <- rep(NA,times=dim(.x)[1])
                     .x$value <- rep(NA,times=dim(.x)[1])
                     return(.x)
                   }else{return(.x)})
  return(df)
}
```

# helpers finding paths

## create_Position_posRefimage_filepath()

```{r}
create_Position_posRefimage_filepath <- function(ScanBasePath,
                                              PositionFolder){
  posRefimage_filepath <- file.path(ScanBasePath,
                                 PositionFolder,
                                 "posref") 
  return(posRefimage_filepath)
  
}
```

## create_Position_FLimage_filepath()

```{r}
create_Position_FLimage_filepath <- function(ScanBasePath,
                                              PositionFolder){
  FLimage_filepath <- file.path(ScanBasePath,
                                 PositionFolder,
                                 "flimages") 
  return(FLimage_filepath)
  
}
```

## create_Position_deltaTL_filepath()

```{r}
create_Position_deltaTLimage_filepath <- function(ScanBasePath,
                                              PositionFolder){
  deltaTLimage_filepath <- file.path(ScanBasePath,
                                 PositionFolder,
                                 "deltaTL") 
  return(deltaTLimage_filepath)
  
}
```

## create_Position__deltaTL_focus_filepath()

```{r}
create_Position_focusimage_filepath <- function(ScanBasePath,
                                              PositionFolder){
  focusimage_filepath <- file.path(ScanBasePath,
                                 PositionFolder,
                                 "focus") 
  return(focusimage_filepath)
  
}
```

## create_Position_HDRimage_filepath()

```{r}
create_Position_HDRimage_filepath <- function(ScanBasePath,
                                              PositionFolder){
  HDRimage_filepath <- file.path(ScanBasePath,
                                 PositionFolder,
                                 "hdr") 
  return(HDRimage_filepath)
  
}
```

## list_HDR_BlobFileName_in_filepath()

```{r}
list_BlobFileName_in_filepath <- function(HDRimage_filepath){
  HDRFiles<-list.files(HDRimage_filepath)
  BlobFiles<-HDRFiles[stringr::str_detect(HDRFiles,".blob32$")]
  BlobFileName<-BlobFiles%>%stringr::str_remove(".blob32$")
  if(length(BlobFileName)==0){
    return(NA)
    }else{return(BlobFileName)}
}
```




