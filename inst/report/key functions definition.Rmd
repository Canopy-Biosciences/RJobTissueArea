---
title: " documentation - key function definition"
subtitle: "reportings on functional development for tissue area detection"
author: "Julia Ortmann"
output: 
  html_document:
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: '3'
    theme:
      bg: "#202123"
      fg: "#B8BCC2"
      primary: "#EA80FC"
      secondary: "#00DAC6"
      base_font:
        google: Prompt
      heading_font:
        google: Proza Libre
abstract: The aim of this build functions for import of scan HDR images, defined by scan_ID
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_file = "inst/report/dev report - key functions definition.html",
      envir = globalenv()
    )
  })
---

```{r setup, include=FALSE}
if (requireNamespace("thematic")) 
  thematic::thematic_rmd(font = "auto")
```

# summary

... 

# introduction 

**process modules**

A) import chip group
B) find all image files
C) image processing steps:

  1) sum pixel of all hdr imgages
  2) convert pixel matrix to pixmapGrey object
  3) blurring via gauss filter
  4) binary filtering via threshold
  5) export tiff-images

D) estimation of tissue size

  1) tissue size estimation (via pixel resolution and amount pixels set TRUE)
  2) return tissue area results (tissue size [mm] and %tissue size)

--> apply on parameterset, positions, chips


# workflows

## import chip group



## find all image files

## image processing

### variables

- **variables**

```{r}
#variables
chip_ID <- "M"
pos <- 1
cellres <- c(1,1)
sigma <- 0.5
threshold <- 4
output_dir <- "inst/data/data_output"
cols <- 1040
rows <- 1392
```

- **secundary variable**

```{r}
#secundary vaiables
result_ID <- create_name_result_ID(chip_ID,
                                   pos,
                                   sigma,
                                   threshold
                                   )
```

### function definition

#### **perform_image_processing() - workflow function**

```{r}
create_pixmapGrey(data_sum,
                  cellres,
                  output_dir,
                  chip_ID,
                  pos,
                  sigma,
                  threshold)

perform_image_processing <- function(data_sum,
                              cellres = cellres,
                              output_dir = output_dir,
                              chip_ID,
                              pos,
                              sigma = sigma,
                              threshold = threshold){
  
  # create data.sum
  
  # export data.sum
  
  # define data_sum as matrix
  m.data_sum <- data.sum%>%
    as.matrix()

  # create pixmap
  # cellres: pixel resolution in horizontal and vertical direction
  image <-pixmap::pixmapGrey(m.data_sum,
                             nrow = rows,
                             ncol = cols,
                             cellres=cellres)
  
  # get grey values
  grey_values <- image@grey * 255
  
  # Low-pass Gaussian filter
  xb <- EBImage::gblur(grey_values,
                       sigma)
  # round values
  xb <- round(xb,digits = 1)
  
  # create blurred pixmap image
  image_blurred <- pixmapGrey(xb,
                              cellres=cellres) 
  
  #threshold filtering
  pos <- which(xb > threshold)
  xt <- xb
  xt[which(xb > threshold)] <- 1
  xt[which(xb <= threshold)] <- 0
  
  # pixmap object of binary image
  image_binary <- image
  image_binary@grey <- xt

  # create tiff of result images
  export_image_result_tiffs(image,
                            image_blurred,
                            image_binary,
                            output_dir,
                            chip_ID,
                            pos,
                            sigma,
                            threshold,
                            cols,
                            rows)
  
}
```
#### **export_image_result_tiffs()**

```{r}
export_image_result_tiffs <- function(image,
                                      image_blurred,
                                      image_binary,
                                      output_dir,
                                      chip_ID,
                                      pos,
                                      sigma,
                                      threshold,
                                      cols,
                                      rows){
  # filename
  result_ID <- create_name_result_ID(chip_ID,
                                     pos,
                                     sigma,
                                     threshold)
  # complete filepath
  file <- create_result_filepath(
    output_dir,
    "result_tiffs",
    result_ID,
    "tiff"
  )
  
  # create tiff object
  tiff(filename = file,
       width = cols*3,
       height = rows)
  
  par(mfrow=c(1,3))
  
  # plot inital image
  plot(image,
       main = "grey value image",
       sub = "sum values by pixels across all hdr images")

  # plot blurred image
  plot(image_blurred,
       main = paste0("blurred with sigma = ",sigma),
       sub = paste0("min: ", min(xb), "max: ",max(xb)))
  
  # plot binary image
  plot(image_binary,
       main= paste0("threshold set to: ",threshold))
  
  dev.off()
  
  writeLines(c(
    paste0("- successful exported processed image results")
    ))
}
```
#### **create_name_result_ID()**

```{r}
create_name_result_ID <- function(chip_ID,
                                  pos,
                                  sigma,
                                  threshold){
  
  result_ID <- paste0("chipID_",chip_ID,
                      "_pos_",pos,
                      "_sigma_",sigma,
                      "_threshold_",threshold)
}
```

#### **create_result_filepath()**
```{r}
create_result_filepath <- function(output_dir,
                                   name_string,
                                   result_ID,
                                   type){
  
  path <- file.path(
    output_dir,
    paste0(name_string,
           "_",result_ID,
           ".",type))
  
  return(path)
}
```

### workflow application

```{r}

```

