---
title: " documentation - scan and position metadata"
subtitle: "reportings on functional development"
author: "Julia Ortmann"
output: 
  html_document:
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: '3'
    theme:
      bg: "#202123"
      fg: "#B8BCC2"
      primary: "#EA80FC"
      secondary: "#00DAC6"
      base_font:
        google: Prompt
      heading_font:
        google: Proza Libre
abstract: The aim of this 
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_file = "inst/report/dev report - investigations in scan and position metadata.html",
      envir = globalenv()
    )
  })
---

```{r setup, include=FALSE}
if (requireNamespace("thematic")) 
  thematic::thematic_rmd(font = "auto")
```

# summary

... 
# introduction 

- map over chip_IDs
- find scan_IDs 
- find positions measured and subselected (TO DISCUSS)
- select approbriate scan images
- import blob files
- set grey value threshold
- sum tissue-pixels and position-pixel
- calculate tissue AREA and POSITION AREA
- count cells
- export chipID cell_count tissue and position area 

## find all scans and cycles {.tabset .tabset-pills}

### find_valid_group_chip_IDs

```{r}
# load library
library(RJobTissueArea)

# define group ID
group_ID <- "P1761451"

# find valid group chip_IDs
chip_IDs <- find_valid_group_chip_IDs(group_ID)
```

### create_MethodHistory_of_chipIDs

```{r}
create_MethodHistory_of_chipIDs <- function(chip_IDs){
  
  query_results <- query_UID_limslager(chip_IDs = chip_IDs)
  EDLs <- get_EDL_from_query_result(query_results)
  MethodHistory <- purrr::map(EDLs,~create_MethodHistory_from_EDL(.x))

  return(MethodHistory)
  }
```

```{r}
MethodHistory <- create_MethodHistory_of_chipIDs(chip_IDs)

MethodHistory[[3]]
```

### create_ScanHistory_of_chipIDs

```{r}
create_ScanHistory_of_chipIDs<-function(MethodHistory){
  ScanHistorys <- purrr::map(MethodHistory,
                             ~.x%>%
                               dplyr::rename("scan_ID" = "UID")%>%
                               dplyr::rename("cycle_ID" = "CycleUID")%>%
                               tidyr::fill(cycle_ID,  .direction = "up")%>%
                               dplyr::filter(Type == "Chipcytometry-Scan")%>%
                               dplyr::select(scan_ID,cycle_ID,Status,Tag,Excluded,PreparedForDataviz))
  return(ScanHistorys)
}
```

```{r}
ScanHistorys <- create_ScanHistory_of_chipIDs(MethodHistory)

ScanHistorys[[3]]
```

### extract_cycle_sequence_from_MethodHistory

```{r}
extract_cycle_sequence_from_MethodHistory <- function(MethodHistory){
  
  cycle_sequence <- purrr::map(MethodHistory,
                               ~.x%>%
                                 dplyr::filter(Type == "Chipcytometry-Cycle")%>%
                                 dplyr::rename("cycle_ID" = "UID")%>%
                                 dplyr::mutate(cycle_pos = 1:dplyr::n())%>%
                                 dplyr::select(cycle_pos,cycle_ID,Status,PreparedForDataviz))
  return(cycle_sequence)
}
```

```{r}
cycle_sequence <-extract_cycle_sequence_from_MethodHistory(MethodHistory)

cycle_sequence[[3]]
```

## get selected Positions {.tabset .tabset-pills}

### get_pos_colnames_in_MethodHistory

```{r}
get_pos_colnames_in_MethodHistory <- function(MH){
  cols <- colnames(MH)
  col_pos <- which(stringr::str_detect(cols,"pos")==TRUE)
  col_scanID <- which(cols %in% c("UID","CycleUID","Taq","Excluded","PreparedForDataviz"))
  return(c(col_scanID,col_pos))
}
```

```{r}
pos_columns <- purrr::map(MethodHistory,
                          ~.x%>%get_pos_colnames_in_MethodHistory)

pos_columns[[3]]
```

### create_pos_df_from_MethodHistory

```{r}
create_pos_df_from_MethodHistory <- function(MethodHistory){
  columns <- purrr::map(MethodHistory,
                          ~.x%>%get_pos_colnames_in_MethodHistory)
  df <- purrr::map2(MethodHistory,
                    columns,
                    ~.x[,.y])
  df <- purrr::map(df,
                   ~.x%>%
                     tidyr::gather("column",
                                   "value",
                                   -UID,
                                   -CycleUID,
                                   -Excluded,
                                   -PreparedForDataviz))
  df <- purrr::map(df,
                   ~if(dim(.x)[2] == 4){
                     .x$column <- rep(NA,times=dim(.x)[1])
                     .x$value <- rep(NA,times=dim(.x)[1])
                     return(.x)
                   }else{return(.x)})
  return(df)
}
```

```{r}
pos_df <- create_pos_df_from_MethodHistory(MethodHistory)

pos_df[[3]]
```

### extract_OK_pos_from_MethodHistory

```{r}
extract_OK_pos_from_MethodHistory <- function(MethodHistory){
  
  df <- create_pos_df_from_MethodHistory(MethodHistory)
  
  OK_col <- purrr::map(df,
                ~which(stringr::str_detect(.x$column,"OK")==TRUE))
  
  OK_scan <- purrr::map2(df,
                         OK_col,
                         ~.x[.y,])
  
  pos_df_OK <- purrr::map(OK_scan,
                            ~.x%>%
    dplyr::filter(value== "True")%>%
    dplyr::mutate(pos = column)%>%
    dplyr::mutate(pos = stringr::str_remove(pos,"pos"))%>%
    dplyr::mutate(pos = stringr::str_remove(pos,"OK"))%>%
    dplyr::group_by(UID)%>%
    dplyr::summarize(pos_OK = paste0(pos,collapse=", ")))
  
  return(pos_df_OK)
}
```

```{r}
pos_df_OK <- extract_OK_pos_from_MethodHistory(MethodHistory)

pos_df_OK[[3]]
```
```{r}
names(pos_df_OK) <- chip_IDs

test <- pos_df_OK%>%
  purrr::set_names()%>%
  purrr::map_df(~.x)

chip_IDs
```

### extract_Ref_pos_from_MethodHistory

```{r}
extract_Ref_pos_from_MethodHistory <- function(MethodHistory){
     
    result <- create_pos_df_from_MethodHistory(MethodHistory)
    
    Ref_col <- purrr::map(result,
                          ~which(stringr::str_detect(.x$column,"Ref")==TRUE))
    
    Ref_scan <- purrr::map2(result,
                            Ref_col,
                            ~.x[.y,])
    
    pos_df_Ref <- purrr::map(Ref_scan,
                               ~.x%>%
                                 dplyr::filter(value== "True")%>%
                                 dplyr::mutate(pos = column)%>%
                                 dplyr::mutate(pos = stringr::str_remove(pos,"pos"))%>%
                                 dplyr::mutate(pos = stringr::str_remove(pos,"Ref"))%>%
                                 dplyr::group_by(UID)%>%
                                 dplyr::summarize(pos_Ref = paste0(pos,collapse=", "))
    )
    
    return(pos_df_Ref)
}
```

```{r}
pos_df_Ref <- extract_Ref_pos_from_MethodHistory(MethodHistory)

pos_df_Ref[[3]]
```

### extract_XYvalues_pos_from_MethodHistory

```{r}
extract_XYvalues_pos_from_MethodHistory <- function(MethodHistory){
  
    df <- create_pos_df_from_MethodHistory(MethodHistory)
    
    X_col <- purrr::map(df,
                        ~which(stringr::str_detect(.x$column,"X")==TRUE))
    X_scan <- purrr::map2(df,
                          X_col,
                          ~.x[.y,])
    pos_df_X <- purrr::map(X_scan,
                           ~.x%>%
                             dplyr::filter(!is.na(value))%>%
                             dplyr::mutate(pos = column)%>%
                             dplyr::mutate(pos = stringr::str_remove(pos,"pos"))%>%
                             dplyr::mutate(pos = stringr::str_remove(pos,"X"))%>%
                             dplyr::group_by(UID)%>%
                             dplyr::summarize(pos = paste0(pos,collapse=", "),
                                              value_X = paste0(value,collapse=", ")))
    
    Y_col <- purrr::map(df,
                        ~which(stringr::str_detect(.x$column,"Y")==TRUE))
    Y_scan <- purrr::map2(df,
                          Y_col,
                          ~.x[.y,])
    pos_df_Y <- purrr::map(Y_scan,
                           ~.x%>%
                             dplyr::filter(!is.na(value))%>%
                             dplyr::mutate(pos = column)%>%
                             dplyr::mutate(pos = stringr::str_remove(pos,"pos"))%>%
                             dplyr::mutate(pos = stringr::str_remove(pos,"Y"))%>%
                             dplyr::group_by(UID)%>%
                             dplyr::summarize(pos = paste0(pos,collapse=", "),
                                              value_Y = paste0(value,collapse=", ")))
    
    pos_df_XY <- purrr::map2(pos_df_X,
                             pos_df_Y,
                             ~dplyr::full_join(
                               .x%>%
                                 tidyr::separate_rows(pos,value_X,sep =", "),
                               .y%>%
                                 tidyr::separate_rows(pos,value_Y,sep =", "),
                               by = c("UID", "pos")
                             ))
    
    return(pos_df_XY)
    
    
  }
  
```

```{r} 
pos_df_XY <- extract_XYvalues_pos_from_MethodHistory(MethodHistory)

pos_df_XY[[3]]
```

## result objects for chip group {.tabset .tabset-pills}

### tibble of all results 

```{r}
result <- dplyr::tibble(chip_ID = chip_IDs)

result <- result%>%
  dplyr::mutate(MethodHistory = create_MethodHistory_of_chipIDs(chip_ID))%>%
  dplyr::mutate(Ref_scans = extract_Ref_pos_from_MethodHistory(MethodHistory),
         OK_positions = extract_OK_pos_from_MethodHistory(MethodHistory),
         XY_pos = extract_XYvalues_pos_from_MethodHistory(MethodHistory),
         ScanHistory = create_ScanHistory_of_chipIDs(MethodHistory),
         cycle_sequence = extract_cycle_sequence_from_MethodHistory(MethodHistory))

result
```

### RefScans_chip_group

```{r}
RefScans_chip_group <- result%>%
  dplyr::select(chip_ID,ScanHistory)%>%
  tidyr::unnest(cols="ScanHistory")%>%
  dplyr::right_join(
    result%>%
      dplyr::select(chip_ID,Ref_scans)%>%
      tidyr::unnest(cols="Ref_scans"),
    by = c("chip_ID","scan_ID"="UID"))

RefScans_chip_group
```

### OKScans_chip_group

```{r}
OKScans_chip_group <- result%>%
  dplyr::select(chip_ID,ScanHistory)%>%
  tidyr::unnest(cols="ScanHistory")%>%
  dplyr::right_join(
    result%>%
      dplyr::select(chip_ID,OK_positions)%>%
      tidyr::unnest(cols="OK_positions"),
    by = c("chip_ID","scan_ID"="UID"))%>%
  dplyr::group_by(chip_ID,pos_OK)%>%
  dplyr::mutate(OK_scans = paste0(scan_ID,collapse=", "))%>%
  dplyr::slice(dplyr::n())

OKScans_chip_group
```

### XYpos_chip_group

```{r}
XYpos_chip_group <- result%>%
  dplyr::select(chip_ID,XY_pos)%>%
  tidyr::unnest(cols="XY_pos",keep_empty = TRUE)%>%
  dplyr::group_by(chip_ID,UID)%>%
  dplyr::mutate(Pos = paste0(pos,collapse = ", "),
                X = paste0(value_X,collapse=", "),
                Y =paste0(value_Y, collapse=", "),
                n_pos = dplyr::n())%>%
  dplyr::select(chip_ID, "scan_ID"="UID",Pos,n_pos,X,Y)%>%
  dplyr::distinct()%>%
  dplyr::left_join(
    result%>%
      dplyr::select(chip_ID,ScanHistory)%>%
      tidyr::unnest(cols="ScanHistory"),
    by = c("chip_ID","scan_ID"))

XYpos_chip_group
```

### TagScans_chip_group

```{r}
TagScans_chip_group <- result%>%
  dplyr::select(chip_ID,ScanHistory)%>%
  tidyr::unnest(cols="ScanHistory")%>%
  dplyr::filter(!is.na(Tag))%>%
  dplyr::left_join(result%>%
                     dplyr::select(chip_ID,cycle_sequence)%>%
                     tidyr::unnest(cols="cycle_sequence")%>%
                     dplyr::select(chip_ID, cycle_ID,cycle_pos),
                   by = c("chip_ID", "cycle_ID"))%>%
    dplyr::group_by(chip_ID)%>%
    dplyr::mutate(scan_pos = 1:dplyr::n())%>%
  dplyr:::select("chip_ID","scan_ID","cycle_ID","cycle_pos","scan_pos",tidyselect::everything())

TagScans_chip_group
```
### BGScans_chip_group

```{r}
BGScans <- TagScans_chip_group%>%
  dplyr::filter(Tag == "BG")
```

### check scan_IDs with and without Taq = NA 

```{r}
na <- which(is.na(TagScans_chip_group$Tag))
na_scanIDs <- TagScans_chip_group$scan_ID[na]

which(na_scanIDs %in% RefScans_chip_group$scan_ID)
which(na_scanIDs %in% OKScans_chip_group$scan_ID)
which(na_scanIDs %in% XYpos_chip_group$scan_ID)
```

