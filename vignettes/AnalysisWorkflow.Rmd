---
title: "AnalysisWorkflow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{AnalysisWorkflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
# With the root.dir option below,
# this vignette runs the R code in a temporary directory
# so new files are written to temporary storage
# and not the user's file space.
package_dir <- rprojroot::find_rstudio_root_file()
dir <- file.path(package_dir)#fs::dir_create(tempfile())
knitr::opts_knit$set(root.dir = dir,
                     base.dir=getwd())
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  root.dir=dir,
  base.dir=getwd())

Sys.setenv(TAR_WARN = "false")

here::i_am("vignettes/AnalysisWorkflow.Rmd")

if (identical(Sys.getenv("NOT_CRAN", unset = "false"), "false")) {
  knitr::opts_chunk$set(eval = FALSE)
}
```

Target Markdown is a powerful R Markdown interface for reproducible analysis pipelines, and the chapter at https://books.ropensci.org/targets/markdown.html walks through it in detail. This R Markdown report the example from the chapter. Try it out in both interactive and non-interactive modes, either by running the code chunks in different ways or setting the `tar_interactive` chunk option.

# Setup

If you are using old versions of `targets` (<= 0.7.0) and/or `knitr` (<= 1.33), you will need to load the `targets` package in the R Markdown document in order for Target Markdown code chunks to work.

```{r}
library(targets)
library(RJobTissueArea)
```

Near the top of the document, you may also wish to remove the `_targets_r` directory previously written by non-interactive runs of the report. Otherwise, your pipeline may contain superfluous targets.

```{r}
tar_unscript()
```

# Globals

We first define some global options/functions common to all targets. The function below plots a histogram of ozone concentrations, and our histogram target will need it.

```{r, echo = FALSE,message=FALSE}
library(targets)
library(magrittr)
library(dplyr)
library(ggplot2)
tar_script({

  options(crayon.enabled = FALSE)
  tar_option_set(memory = "transient", garbage_collection = TRUE)
  tar_option_set(packages = c("RJobTissueArea","tibble", "readr", "dplyr", "ggplot2"),
                 imports = "RJobTissueArea")
  
  extract_chipIDs_from_groupEDL<- function(EDL){
  chip_IDs <- EDL%>%
    xml2::read_xml()%>%
    xml2::xml_find_all("/Obj/EncapsulatedObjectsRef/ObjRef")%>%
    xml2::xml_attr("UID")

  return(chip_IDs)
}
 # #load all package functions
 # Rfiles <- list.files("R")
 # purrr::walk(Rfiles,~source(file.path("R",.x)))
  
#  list(
#    tar_target(group_ID, "P1761451"),
#    tar_target(valid_chipIDs,
#               group_ID%>%
#                 find_valid_group_chip_IDs())
#  )
# # list(tar_target(group_ID, "P1761451"),
 #      tar_target(valid_chipIDs,
 #                 query_mongoDB("limslager","UID",group_ID)%>%
 #                   get_EDL_from_query_result()%>%
 #                   extract_chipIDs_from_groupEDL()%>%
 #                   check_if_chip_data_exist())
 # )
list(
  tar_target(group_ID, "P1761451"),
  tar_target(query_result,
             query_mongoDB("limslager","UID",group_ID)),
  tar_target( EDL,
              query_result%>%get_EDL_from_query_result()),
  tar_target(chip_IDs,
             EDL%>%extract_chipIDs_from_groupEDL()),
  tar_target(valid_chipIDs,
             chip_IDs%>%check_if_chip_data_exist())
)
 
})

```

# Targets

Our first target borrows the `airquality` dataset built into base R.


# Pipeline

If you ran all the `{targets}` chunks in non-interactive mode, then your R scripts are set up to run the pipeline.

```{r,output =FALSE}
tar_make()
```



```{r}
?tar_visnetwork()
```

```{r}
tar_glimpse()
```




```{r}
tar_sitrep()
```



```{r}
tar_manifest()
```


```{r}
targets::tar_watch()
```


```{r}
if (identical(Sys.getenv("TAR_LONG_EXAMPLES"), "true")) {
targets::tar_dir({ # tar_dir() runs code from a temporary directory.
tar_script({

  options(crayon.enabled = FALSE)
  tar_option_set(memory = "transient", garbage_collection = TRUE)
  tar_option_set(packages = c("RJobTissueArea","tibble", "readr", "dplyr", "ggplot2"),
                 imports = "RJobTissueArea")
  
  extract_chipIDs_from_groupEDL<- function(EDL){
  chip_IDs <- EDL%>%
    xml2::read_xml()%>%
    xml2::xml_find_all("/Obj/EncapsulatedObjectsRef/ObjRef")%>%
    xml2::xml_attr("UID")

  return(chip_IDs)
}
 # #load all package functions
 # Rfiles <- list.files("R")
 # purrr::walk(Rfiles,~source(file.path("R",.x)))
  
#  list(
#    tar_target(group_ID, "P1761451"),
#    tar_target(valid_chipIDs,
#               group_ID%>%
#                 find_valid_group_chip_IDs())
#  )
# # list(tar_target(group_ID, "P1761451"),
 #      tar_target(valid_chipIDs,
 #                 query_mongoDB("limslager","UID",group_ID)%>%
 #                   get_EDL_from_query_result()%>%
 #                   extract_chipIDs_from_groupEDL()%>%
 #                   check_if_chip_data_exist())
 # )
list(
  tar_target(group_ID, "P1761451"),
  tar_target(query_result,
             query_mongoDB("limslager","UID",group_ID)),
  tar_target( EDL,
              query_result%>%get_EDL_from_query_result()),
  tar_target(chip_IDs,
             EDL%>%extract_chipIDs_from_groupEDL()),
  tar_target(valid_chipIDs,
             chip_IDs%>%check_if_chip_data_exist())
)
 
})
targets::tar_make()
})
}
```

